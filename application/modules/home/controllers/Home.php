<?php if (!defined('BASEPATH')) exit('No direct script access allowed');//include_once('/application/libraries/adminController.php');include_once(APPPATH . 'libraries/baseController.php');class home extends baseController{	function home()	{		parent::baseController();		$CI = &get_instance();		$CI->load->helper(array('url', 'html', 'home', 'cookie', 'captcha'));		$CI->load->database();		$CI->load->library(array('encryption', 'pagination', 'session'));        $timezone = "Asia/Calcutta";        date_default_timezone_set($timezone);	}	/**	 * Description: index page	 * Function: index	 * @author: Phuong	 * @params: none	 * @return: boolean	 * @version: 1.0	 */	public function index()	{		$CI = &get_instance();		$CI->load->model('asds_model');		$CI->load->model('products_model');		//$this->load->helper('html');		$layout = '/home/main';		$metaDes = 'Đăng tin rao vặt miễn phí theo danh mục';		$metaKey = 'Pho rao vat mien phi';		//get list of categories		$cateModel = 'categories_model';		$cateLstFncName = 'getListCategories';		$arrListCate = $this->getListCate($cateModel, $cateLstFncName, '', '');		//get list of categories limit 10		$arrListCate10 = $this->getListCate($cateModel, $cateLstFncName, 10, '');		$arrCurAsds = $CI->asds_model->getListProdSlider('id, cate_id, title, price, created, image', 39);		$arrProducts = $CI->products_model->getListProd('id, fcate_id, title, price, created, image', 36);		$data['arrProducts'] = $arrProducts;		$data['arrCurAsds'] = $arrCurAsds;		$data['contents'] = '/home/home';		$data['title'] = '-- PhoRaoVat.net --';		$data['arrListCate'] = $arrListCate;		$data['arrListCate10'] = $arrListCate10;		$this->load->view($layout, $data);		//$this->template->load('/home/main', '/home/home', $data);	}	/**	 * Description: ds_raovat page	 * Function: ds_raovat	 * @author: Phuong	 * @params: id	 * @return: array	 * @version: 1.0	 */	public function danh_sach_rao_vat($cateId, $pageNum = 1)	{		$CI = &get_instance();		$CI->load->model('asds_model');		$CI->load->model('categories_model');		$cateId = $CI->getID($cateId);		//get category name		$cateName = $CI->categories_model->getField($cateId, 'name');		foreach ($cateName as $cate) {			$data['cateName'] = $cate->name;		}		$total_row = $CI->asds_model->record_count('fcate_id',$cateId);		//Paging congig		// Initialize empty array.		$config = array();		// Set base_url for every links		$config["base_url"] = base_url() . 'home/danh-sach-rao-vat/' . str_replace(' ', '-', convert_vi_to_en($cate->name)) . '-' . $cateId . '.html';		// Set total rows in the result set you are creating pagination for.		$config["total_rows"] = $total_row;		// Number of items you intend to show per page.		$config["per_page"] = 15;		// Use pagination number for anchor URL.		$config['use_page_numbers'] = TRUE;		//Set that how many number of pages you want to view.		$config['num_links'] = 2;		// Open tag for CURRENT link.		$config['cur_tag_open'] = '&nbsp;<a class="current">';		// Close tag for CURRENT link.		$config['cur_tag_close'] = '</a>';		// By clicking on performing NEXT pagination.		$config['next_link'] = 'Trang kế';		// By clicking on performing PREVIOUS pagination.		$config['prev_link'] = 'Trang trước';		$config['last_link'] = 'Trang cuối';        $config['first_link'] = 'Trang đầu';		// To initialize "$config" array and set to pagination library.		$CI->pagination->initialize($config);		//$start = $pageNum * $config["per_page"];		$start = $pageNum;		if ($CI->uri->segment(4)) {			//echo 'go to page '.$CI->uri->segment(4);die;			$start = $CI->uri->segment(4) * $config["per_page"];		}		//echo 'total '.$total_row.' id là '.$cateId . ' trang '. $start . ' and ' . $config["base_url"].'<br />';die;		//get list of categories		$arrProducts = $CI->asds_model->getListProdPaging('id,cate_id,title,description,image', $cateId, $config["per_page"], $start);		$str_links = $CI->pagination->create_links();		$data["paginations"] = explode('&nbsp;', $str_links);		$arrProductsRight = $CI->asds_model->getListProd('id,cate_id,title,description,image', $cateId, 9);		//set to view		$layout = '/home/main';		$data['arrProducts'] = $arrProducts;		$data['arrProductsRight'] = $arrProductsRight;		$data['contents'] = '/home/ds_raovat';		$data['title'] = '-- PhoRaoVat.net -> Danh sách tin rao --';		$CI->load->view($layout, $data);		//echo 'Phuong Truong';exit;	}	/**	 * Description: chitiet page	 * Function: chitiet	 * @author: Phuong	 * @params: id	 * @return: array	 * @version: 1.0	 */	public function chi_tiet($id)	{		$CI = &get_instance();		$CI->load->model('asds_model');		$CI->load->model('categories_model');		$detailProduct = $CI->asds_model->getDetail('id,cate_id,local_id,sublocal_id,mem_id,title,description,detail,price,image,created', $id);		foreach ($detailProduct as $prod) {			$cateId = $prod->cate_id;			$memId = $prod->mem_id;		}		$arrProductsRight = $CI->asds_model->getListProd('id,cate_id,title,description,image', $cateId, 9);		$moreProducts = $CI->asds_model->getListProdMore('id,cate_id,title,description,image', $cateId, $memId);		$layout = '/home/main';		$data['contents'] = '/home/chi_tiet';		$data['title'] = '-- PhoRaoVat.net -> chi tiet tin rao --';		$data['detailProduct'] = $detailProduct;		$data['arrProductsRight'] = $arrProductsRight;		$data['moreProducts'] = $moreProducts;		$CI->load->view($layout, $data);	}	/**	 * Description: ds_raovat page	 * Function: ds_raovat	 * @author: Phuong	 * @params: id	 * @return: array	 * @version: 1.0	 */	public function danh_sach_rao_vat_con($cateId, $subCateId, $pageNum = 1)	{		$CI = &get_instance();		$CI->load->model('asds_model');		$CI->load->model('categories_model');		$CI->load->model('subcategories_model');		$subCateId = explode('-', preg_replace('/.html/', '', $subCateId));		$subCateId = end($subCateId);		//get subcategory name		$subCateName = $CI->subcategories_model->getField($cateId, $subCateId, 'name');		foreach ($subCateName as $subcate) {			$data['subCateName'] = $subcate->name;		}		$total_row = $CI->asds_model->record_count($cateId, $subCateId);		//Paging congig		// Initialize empty array.		$config = array();		// Set base_url for every links		$config["base_url"] = base_url() . 'home/danh-sach-rao-vat-con/' . $cateId . '/' . $subCateId . '/';		// Set total rows in the result set you are creating pagination for.		$config["total_rows"] = $total_row;		// Number of items you intend to show per page.		$config["per_page"] = 10;		// Use pagination number for anchor URL.		$config['use_page_numbers'] = TRUE;		//Set that how many number of pages you want to view.		$config['num_links'] = 1;		// Open tag for CURRENT link.		$config['cur_tag_open'] = '&nbsp;<a class="current">';		// Close tag for CURRENT link.		$config['cur_tag_close'] = '</a>';		// By clicking on performing NEXT pagination.		$config['next_link'] = 'Next';		// By clicking on performing PREVIOUS pagination.		$config['prev_link'] = 'Previous';		// To initialize "$config" array and set to pagination library.		$CI->pagination->initialize($config);		$start = $pageNum * $config["per_page"];		//get list of categories		$arrProducts = $CI->asds_model->getListProdPaging2('id,cate_id,subcate_id,title,description,image', $cateId, $subCateId, $config["per_page"], $start);		$str_links = $CI->pagination->create_links();		$data["paginations"] = explode('&nbsp;', $str_links);		$arrProductsRight = $CI->asds_model->getListProd('id,cate_id,title,description,image', $cateId, 9);		//set to view		$layout = '/home/main';		$data['arrProducts'] = $arrProducts;		$data['arrProductsRight'] = $arrProductsRight;		$data['contents'] = '/home/ds_raovat1';		$data['title'] = '-- PhoRaoVat.net -> Danh sách tin rao --';		$CI->load->view($layout, $data);		//echo 'Phuong Truong';exit;	}	/**	 * Description: ds_raovat page	 * Function: ds_raovat	 * @author: Phuong	 * @params: id	 * @return: array	 * @version: 1.0	 */	public function tin_rao_theo_khu_vuc($localCode, $pageNum = 1)	{		$CI = &get_instance();		$CI->load->model('asds_model');		$CI->load->model('categories_model');		$CI->load->model('locations_model');		$oldUrl = $localCode;		$localCode = $CI->getID($localCode);		$localId = $CI->locations_model->getIdByCode($localCode);		//echo($localId);die;		//get category name		$localName = $CI->locations_model->getField($localId, 'name');		foreach ($localName as $local) {			$data['localName'] = $local->name;		}		$total_row = $CI->asds_model->record_count_local($localId);		//Paging congig		// Initialize empty array.		$config = array();		// Set base_url for every links		$config["base_url"] = base_url() . 'home/danh-sach-rao-vat/' . $oldUrl;		// Set total rows in the result set you are creating pagination for.		$config["total_rows"] = $total_row;		// Number of items you intend to show per page.		$config["per_page"] = 10;		// Use pagination number for anchor URL.		$config['use_page_numbers'] = TRUE;		//Set that how many number of pages you want to view.		$config['num_links'] = 2;		// Open tag for CURRENT link.		$config['cur_tag_open'] = '&nbsp;<a class="current">';		// Close tag for CURRENT link.		$config['cur_tag_close'] = '</a>';		// By clicking on performing NEXT pagination.		$config['next_link'] = 'Next';		// By clicking on performing PREVIOUS pagination.		$config['prev_link'] = 'Previous';		// To initialize "$config" array and set to pagination library.		$CI->pagination->initialize($config);		$start = $pageNum * $config["per_page"];		//echo 'total '.$total_row.' local_id là '.$localId . ' trang '. $start . ' and ' . $config["base_url"].'<br />';		//get list of categories		$arrProducts = $CI->asds_model->getListProdLocalPaging('id,cate_id,title,description,image', $localId, $config["per_page"], $start);		$str_links = $CI->pagination->create_links();		$data["paginations"] = explode('&nbsp;', $str_links);		$arrProductsRight = $CI->asds_model->getListProdLocal('id,cate_id,title,description,image', $localId, 9);		//set to view		$layout = '/home/main';		$data['arrProducts'] = $arrProducts;		$data['arrProductsRight'] = $arrProductsRight;		$data['contents'] = '/home/ds_raovat_local';		$data['title'] = '-- PhoRaoVat.net -> Danh sách tin rao theo khu vực --';		$CI->load->view($layout, $data);		//echo 'Phuong Truong';exit;	}	/**	 * Description: đang ký thành viên mới	 * Function: dang_ky	 * @author: Phuong	 * @params: none	 * @return: array	*/	public function dang_ky() {		$CI = &get_instance();		$CI->load->model('members_model');		$layout = '/home/main';		$data['title'] = '-- PhoRaoVat.net -> Đăng ký thành viên --';		if ($CI->input->post('dangky')) {			//echo password_hash($CI->input->post('password'), PASSWORD_BCRYPT);die;			$inputCaptcha = $this->input->post('captcha');			$sessCaptcha = $this->session->userdata('captchaCode');			if($inputCaptcha === $sessCaptcha){				echo 'Captcha code matched.';			}else{				echo 'Captcha code was not match, please try again.';			}			$arrDataMember = array(				'username'  => $CI->input->post('username'),				'email'     =>  $CI->input->post('email'),				'status'    =>  1,				//'password'  =>  do_hash($CI->input->post('password'),'md5')				'password'  =>  md5($CI->input->post('password'))			);			if($CI->members_model->addNew($arrDataMember, 'members')) {				$CI->session->set_flashdata("memMsg", "Đăng ký thành công!");				redirect(base_url().'home/login');			} else {				$CI->session->set_flashdata("memMsg", "Đăng ký không thành công!");				redirect(base_url().'home/dang_ky');			}			//print_r($arrDataMember);exit;		} else {			$capt_config = array(				//'word'          => 'Random word',				'img_path'      => './captcha/',				'img_url'       => base_url() . 'captcha/',				'font_path'     => './bootstrap/fonts/FontAwesomeb.otf',				'img_width'     => '200',				'img_height'    => 50,				'expiration'    => 7200,				'word_length'   => 6,				'font_size'     => 34,				'img_id'        => 'Imageid',				'pool'          => '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ',				// White background and border, black text and red grid				'colors'        => array(					'background' => '',					'border' => '',					'text' => array(0, 0, 0),					'grid' => ''				)			);			$captcha = create_captcha($capt_config);			// Unset previous captcha and store new captcha word			$this->session->unset_userdata('captchaCode');			$this->session->set_userdata('captchaCode',$captcha['word']);			$data['captchaImg'] = $captcha['image'];			$data['contents'] = '/home/dang_ky';			$CI->load->view($layout, $data);		}	}	//Refresh captcha code	public function refresh() {		// Captcha configuration		$capt_config = array(			'img_path'      => './captcha/',			'img_url'       => base_url() . 'captcha/',			'font_path'     => './bootstrap/fonts/FontAwesomeb.otf',			'img_width'     => '200',			'img_height'    => 50,			'expiration'    => 7200,			'word_length'   => 6,			'font_size'     => 20,			'img_id'        => 'Imageid',			'pool'          => '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ',			'colors'        => array(				'background' => '',				'border' => '',				'text' => array(0, 0, 0),				'grid' => ''			)		);		$captcha = create_captcha($capt_config);		// Unset previous captcha and store new captcha word		$this->session->unset_userdata('captchaCode');		$this->session->set_userdata('captchaCode', $captcha['word']);		echo $captcha['image'];die;	}	//User role information	public function userRule(){		$CI = &get_instance();		$layout = '/home/main';		$data['title'] = '-- PhoRaoVat.net -> Quy Định Sử Dụng --';		$data['contents'] = '/home/userRule';		$CI->load->view($layout, $data);	}	//Check existing username	public function userExist() {		$CI = &get_instance();		$CI->load->model('members_model');		if ($CI->input->post('username')) {			//echo $CI->input->post('username');exit;			$existUser = $CI->members_model->checkExistuser('username', $CI->input->post('username'));			//echo count($existUser);die;			if (count($existUser) > 0) {				$valid = 'false';//Tồn tại trên database			} else {				$valid = 'true';			}			echo $valid;die;		}	}	//Check existing email	public function emailExist() {		$CI = &get_instance();		$CI->load->model('members_model');		if ($CI->input->post('email')) {			//echo $CI->input->post('username');exit;			$existUser = $CI->members_model->checkExistuser('email', $CI->input->post('email'));			//echo count($existUser);die;			if (count($existUser) > 0) {				$valid = 'false';//Tồn tại trên database			} else {				$valid = 'true';			}			echo $valid;die;		}	}	//Member login function	public function login() {		$CI = &get_instance();		$CI->load->model('members_model');		$layout = '/home/main';		$data['title'] = '-- PhoRaoVat.net / Đăng nhập --';		if ($CI->input->post('login')) {			$username = addslashes($CI->input->post('username'));			$password = addslashes($CI->input->post('password'));			//echo md5($password);die;			$wh = " WHERE password = '". md5($password) . "' AND username = '" . $username . "'";			$field_name = "id";			$tbname = 'members';			//echo $wh;die;			$curID = $CI->members_model->get_field($field_name, $tbname, $wh);			if ($curID && $curID != NULL) {				$CI->session->set_flashdata("memMSG", "Welcome back to member panel");				$field_name = 'username, email, status';				$tbname = 'members';				$memData = $CI->members_model->getUserInfo($curID, $tbname, $field_name);				$data = array(					'memId'     => $curID,					'memName'   => $memData->username,					'memEmail'  => $memData->email,					'memStatus' => $memData->status,				);				$this->session->set_userdata($data);				if($this->session->userdata("last_homepage")){					redirect($this->session->userdata("last_homepage"));				}else{					redirect(base_url().'home');				}			} else {				$CI->session->set_flashdata("memMSG", "Can not login, please try again");				redirect(base_url('home').'login');			}		}		$data['contents'] = '/home/login';		$CI->load->view($layout, $data);	}	//logout action	public function logout(){		$this->session->sess_destroy();		redirect(base_url());	}	//Member asd list	public function tin_rao_cua_toi($pageNum = 1) {		if (!$this->session->userdata("memName")) {			$this->session->sess_destroy();			redirect(base_url());		}		$CI = &get_instance();		$CI->load->model('asds_model');		$CI->load->model('categories_model');		$memId = $this->session->userdata("memId");		$total_row = $CI->asds_model->record_count('mem_id',$memId);		//echo $total_row;die;		// Initialize empty array.		$config = array();		// Set base_url for every links		$config["base_url"] = base_url() . 'home/tin-rao-cua-toi/';		// Set total rows in the result set you are creating pagination for.		$config["total_rows"] = $total_row;		// Number of items you intend to show per page.		$config["per_page"] = 10;		// Use pagination number for anchor URL.		$config['use_page_numbers'] = TRUE;		//Set that how many number of pages you want to view.		$config['num_links'] = 2;		// Open tag for CURRENT link.		$config['cur_tag_open'] = '&nbsp;<a class="current">';		// Close tag for CURRENT link.		$config['cur_tag_close'] = '</a>';		// By clicking on performing NEXT pagination.		$config['next_link'] = 'Next';		// By clicking on performing PREVIOUS pagination.		$config['prev_link'] = 'Previous';		// To initialize "$config" array and set to pagination library.		$CI->pagination->initialize($config);		//$start = $pageNum * $config["per_page"];		$start = $pageNum;		if ($CI->uri->segment(4)) {			//echo 'go to page '.$CI->uri->segment(4);die;			$start = $CI->uri->segment(4) * $config["per_page"];		}		//echo 'total '.$total_row.' id là '.$cateId . ' trang '. $start . ' and ' . $config["base_url"].'<br />';		//get list of categories		$arrProducts = $CI->asds_model->getListProdMemPaging('id, mem_id, cate_id, title, description, image', $memId, $config["per_page"], $start);		$str_links = $CI->pagination->create_links();		$data["paginations"] = explode('&nbsp;', $str_links);		/*echo '<pre>';		print_r($arrProducts);		echo '</pre>';		die;*/		$layout = '/home/main';		$data['arrProducts'] = $arrProducts;		$data['contents'] = '/home/myAsd';		$data['title'] = '-- PhoRaoVat.net -> Danh sách tin rao --';		$CI->load->view($layout, $data);	}	//Add/edit asds of member function	public function them_tin_rao($id = 0) {		$this->session->set_userdata('last_homepage', base_url(uri_string()));		if (!$this->session->userdata("memName")) {			redirect(base_url());		}		$CI = &get_instance();		$CI->load->model('asds_model');		$CI->load->model('categories_model');		$CI->load->model('subcategories_model');		$CI->load->model('sub2categories_model');		$memId = $this->session->userdata("memId");		$arrOpt = $CI->getOpt('categories_model','getAllCategories');		$arrSubOpt = $CI->getOpt('subcategories_model','getAllCategories');		$arrSubOpt[0] = '-- Select Sub Category --';		$arrSubOpt1 = $CI->getOpt('sub2categories_model','getAllCategories');		$layout = '/home/main';		$data['errors'] = '';		$data['arrOpt'] = $arrOpt;		$data['arrSubOpt'] = $arrSubOpt;		$data['arrSubOpt1'] = $arrSubOpt1;		//echo $id;die;		if($id > 0) {//edit asds			$lstProd = $CI->asds_model->getMemAsdsDetail($id);			//$data['lstCate'] = $lstCate;			$data['uID'] = $id;			foreach ($lstProd as $prod) {				$data['name'] = $prod->title;				$data['description'] = $prod->description;				$data['detail'] = $prod->detail;				$data['price'] = $prod->price;				$data['promo'] = $prod->promo;				$data['image'] = $prod->image;				$data['created'] = $prod->created;				$data['rank'] = $prod->rank;				$data['status'] = $prod->status;				$data['fcate_id'] = $prod->fcate_id;				$data['cate_id'] = $prod->cate_id;				$data['subcate_id'] = $prod->subcate_id;			}			$data['caption'] = 'Chỉnh Sửa Tin Rao';			$data['contents'] = '/home/addEditAsds';			$data['title'] = 'Member Page - Edit Asds';			$this->load->view($layout, $data);		} else {//add new asds			if($CI->input->post('saveEdit')){				$arrData =array(					'name'  => $CI->input->post('title'),					'fcate_id' => $CI->input->post('fcate_id'),					'cate_id' => $CI->input->post('cate_id'),					'subcate_id' => $CI->input->post('subcate_id'),					'description'     =>  $CI->input->post('description'),					'detail'  => $CI->input->post('detail'),					'status'    =>  ($CI->input->post('status') == 'on') ? 1 : 0,					'rank'  =>  $CI->input->post('rank')				);				if($_FILES['img']['name']){					$arrData['image'] = $_FILES['img']['name'];					$config['upload_path']          = 'upload/asds/';					$config['allowed_types']        = 'gif|jpg|png';					$config['max_size']             = 100;					$config['max_width']            = 1024;					$config['max_height']           = 768;					$this->load->library('upload', $config);					if ( ! $this->upload->do_upload('img')){						$data['caption'] = 'Tạo Mới Tin Rao';						$data['contents'] = '/home/addEditAsds';						$data['title'] = 'Member Home Page - Add New Asds';						$data['errors'] = $this->upload->display_errors();						$this->load->view($layout, $data);					}				}				if($CI->asds_model->addNew('products',$arrData)){					redirect('home/tin-rao-cua-toi');				}			}			$data['addNew'] = 'addNew';			$data['caption'] = 'Tạo Mới Tin Rao';			$data['contents'] = '/home/addEditAsds';			$data['title'] = 'Member Page - Add New Asds';			$this->load->view($layout, $data);		}	}	//Refresh Asds via date update	public function refreshAsds($id) {		$CI = &get_instance();		$CI->load->model('asds_model');		$table = 'asds';		$data['created'] = date('Y-m-d H:i:s');		$CI->asds_model->updateData($id, $data, $table);	}    /**     * Description: chi tiet san pham     * Function: chi tiet san pham     * @author: Phuong     * @params: id     * @return: array     * @version:     */    public function chi_tiet_san_pham($id)    {        $CI = &get_instance();        $CI->load->model('products_model');        $CI->load->model('categories_model');//        $CI->load->model('layout_model');        $tmpList = explode('_', $id);        $prodId = explode('.', end($tmpList));        $prodId = reset($prodId);//        $lstLayout = $CI->layout_model->getList(1);//        $data['lstLayout'] = $lstLayout;        $detailProduct = $CI->products_model->getDetail($prodId);        foreach ($detailProduct as $prod) {            $cateId = $prod->cate_id;        }        $arrCategory = $CI->categories_model->getAllCategories();        $moreProducts = $CI->products_model->getListProdMore('id,cate_id,title,description,image, created', $cateId);        $layout = '/home/main';        $data['contents'] = '/home/products/chi_tiet_san_pham';        $data['title'] = 'Chi tiết sản phẩm';        $data['detailProduct'] = $detailProduct;        $data['arrCategory'] = $arrCategory;        $data['moreProducts'] = $moreProducts;        $CI->load->view($layout, $data);    }}?>